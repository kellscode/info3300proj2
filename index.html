<html>
  <head>
    <title>Spotify Top Songs Over the Years</title>
    <!-- D3 IMPORT HERE -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- D3 IMPORT HERE -->
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap");
      .tooltip {
        position: absolute;
        background-color: #f5f5dc;
        padding: 10px;
        border-radius: 10px;
        font-family: "Quicksand", sans-serif;
        pointer-events: none;
      }

      text {
        font-family: "Quicksand", sans-serif;
        font-size: 18px;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .frame {
        fill: none;
        stroke: #000;
        stroke-width: 2px;
      }
    </style>
  </head>
  <body>
    <p>Author: Kelly Lee (yl3267)</p>
    <svg id="scatterPlot" width="800" height="600"></svg>
    <div id="tooltip" class="tooltip" style="opacity: 80"></div>
    <script>
      let margin = { top: 50, right: 50, bottom: 50, left: 70 };
      let svg = d3.select("#scatterPlot");
      let width = +svg.attr("width") - margin.left - margin.right;
      let height = +svg.attr("height") - margin.top - margin.bottom;
      let chart = svg
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);
      let tooltip = d3.select("#tooltip");

      svg
        .append("rect")
        .attr("x", margin.left)
        .attr("y", margin.top)
        .attr("height", height)
        .attr("width", width)
        .attr("class", "frame");

      // load data
      d3.csv("spotify-2023.csv").then(function (data) {
        // filter out invalid text
        let invalidText = /[^\x00-\x7F]+/;

        data = data.filter(function (d) {
          // filter out any rows where track_name or artist_name contains non-ASCII characters
          return !(
            invalidText.test(d.track_name) || invalidText.test(d.artist_name)
          );
        });

        data.forEach(function (d) {
          d.streams = +d.streams;
          d.in_spotify_charts = +d.in_spotify_charts;
          d.released_year = +d.released_year;
        });

        let filteredData = data.filter(function (d) {
          return d.streams > 300000000;
        });

        let xScale = d3
          .scaleLinear()
          .domain(d3.extent(filteredData, (d) => d.streams))
          .range([0, width]);
        let yScale = d3
          .scaleLinear()
          .domain(d3.extent(filteredData, (d) => d.in_spotify_charts))
          .range([height, 0]);

        let xAxis = svg
          .append("g")
          .attr("class", "x-axis")
          .attr(
            "transform",
            `translate(${margin.left}, ${height + margin.top})`
          )
          .call(
            d3.axisBottom(xScale).tickFormat(function (d) {
              return d / 1000 + "k";
            })
          );

        xAxis
          .append("text")
          .attr("x", width / 2)
          .attr("y", 50)
          .attr("fill", "#000")
          .text("Streams");

        let yAxis = svg
          .append("g")
          .attr("class", "y-axis")
          .attr("transform", `translate(${margin.left}, ${margin.top})`)
          .call(d3.axisLeft(yScale));

        yAxis
          .append("text")
          .attr("x", -height / 2)
          .attr("y", -50)
          .attr("fill", "#000")
          .attr("text-anchor", "middle")
          .attr("transform", "rotate(-90)")
          .text("In Spotify Charts");

        // create color scale
        let fillColor = [
          "#AEC6CF",
          "#FBCCE7",
          "#FFD1DC",
          "#DEA5A4",
          "#B39EB5",
          "#FF6961",
          "#CB99C9",
          "#B19CD9",
          "#FFB347",
          "#FDFD96",
          "#836953",
          "#779ECB",
          "#966FD6",
          "#C23B22",
          "#03C03C",
          "#FF5A36",
          "#76D7EA",
          "#77DD77",
          "#FFB347",
          "#AEC6CF",
          "#F49AC2",
          "#CFCFC4",
          "#B39EB5",
          "#FF6961",
        ];

        let colorScale = d3
          .scaleOrdinal()
          .domain(d3.range(2000, 2024)) // range of release years
          .range(fillColor); // color scheme

        svg
          .append("text")
          .attr("x", width / 2 + margin.left)
          .attr("y", margin.top / 2)
          .attr("text-anchor", "middle")
          .style("font-size", "24px")
          .text("Top Songs on Spotify");

        let dots = chart
          .selectAll(".dot")
          .data(filteredData)
          .enter()
          .append("g")
          .attr("class", "dot");

        dots.each(function (d) {
          let dot = d3.select(this);

          dot
            .append("circle")
            .attr("cx", (d) => xScale(d.streams))
            .attr("cy", (d) => yScale(d.in_spotify_charts))
            .attr("r", 5)
            .attr("fill", (d) => colorScale(d.released_year))
            .attr("stroke", (d) => colorScale(d.released_year))
            .attr("stroke-width", 2)
            .attr("opacity", 0.7)
            .on("mouseover", function (event, d) {
              d3.select(this).attr("r", 8);
              tooltip.transition().duration(200).style("opacity", 0.9);
              tooltip
                .html(
                  "Song: " + d.track_name + "<br/>" + "Artist: " + d.artist_name
                )
                .style("left", d3.pointer(event)[0] + 30 + "px")
                .style("top", d3.pointer(event)[1] + 30 + "px");
            })
            .on("mouseout", function (d) {
              d3.select(this).attr("r", 5);
              tooltip.transition().duration(500).style("opacity", 0);
            });
        });

        // create drop down to select release years
        let select = d3
          .select("body")
          .append("select")
          .style("position", "absolute")
          .style("right", "840px")
          .style("top", "70")
          .on("change", function () {
            let selectedYear = this.value;
            if (selectedYear === "all years") {
              // if "All Years" is selected, show all dots
              dots.attr("display", null);
            } else {
              dots.attr("display", (d) =>
                d.released_year == selectedYear ? null : "none"
              ); // otherwise, show only dots for selected year
            }
          });

        // add options to drop down
        select
          .selectAll("option")
          .data(["all years"].concat(d3.range(2000, 2024))) // range of years
          .enter()
          .append("option")
          .attr("value", (d) => d)
          .text((d) => d);
      });
    </script>
  </body>
</html>
